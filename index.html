<!DOCTYPE html>
<html>
    <head>
        <title>Asset "{{ ASSET_NAME }}"</title>
        <link rel="stylesheet" href="styles.css"/>
        <link rel="icon" href="images/favicon.png"/>
    </head>
    <body>
        <h1 class="asset_title">{{ ASSET_NAME_ID }}</h1>
        <h1 class="asset_moderated_message" hidden>Asset is private, archived, or has been moderated</h1>
        <canvas id="visualizer"></canvas>
        <div id="mediaPlayerControls">
            <audio id="playable" src="{{ CACHE_SOURCE }}" hidden></audio>
            <div id="picture"></div>
            <div id="icon_playpause" class="media_icon icon_play"></div>
            <input id="slider_time" type="range" value="0"/>
        </div>
        <script>
            window.addEventListener("load",function(ev){
                var media_icon=document.getElementById("icon_playpause");
                var durationSlider=document.getElementById("slider_time");
                var theaudio=document.getElementById("playable");
                var canvas=document.getElementById("visualizer");
                var isPlay=false;
                theaudio.load();
                theaudio.addEventListener("timeupdate", function() {
                    durationSlider.value=theaudio.currentTime;
                    durationSlider.max=theaudio.duration;
                });
                durationSlider.addEventListener("change", function() {
                    theaudio.currentTime=durationSlider.value;
                });
                theaudio.addEventListener("pause",function(ev){
                    isPlay=false;
                    media_icon.className="media_icon icon_play";
                });
                theaudio.addEventListener("play",function(ev){
                    isPlay=true;
                    media_icon.className="media_icon icon_pause";
                });
                media_icon.addEventListener("click",function(ev){
                    if (isPlay) {
                        isPlay=false;
                        media_icon.className="media_icon icon_play";
                        theaudio.pause();
                    }else{
                        isPlay=true;
                        media_icon.className="media_icon icon_pause";
                        theaudio.play();
                    };
                });
                function analyser_handler(){
                    canvas.width=document.innerWidth;
                    canvas.height=document.innerHeight;
                    var drawctx=canvas.getContext("2d");
                    var audioctx=new AudioContext();
                    var mediaSource=audioctx.createMediaElementSource(theaudio);
                    var analyser=new AnalyserNode(audioctx);
                    analyser.fftSize=128;
                    mediaSource.connect(analyser);
                    analyser.connect(audioctx.destination);
                    var dataArray=new Uint8Array();
                    function renderFrame(){
                        analyser.getByteFrequencyData(dataArray);
                        var canvasWidth=canvas.width;
                        var canvasHeight=canvas.height;
                        var freqBinCount=analyser.frequencyBinCount;
                        var barWidth=canvasWidth/freqBinCount;
                        drawctx.clearRect(0,0,canvasWidth,canvasHeight);
                        for (var i=0;i<freqBinCount;i++) {
                            var barHeight=dataArray[i]/255 * canvasHeight;
                            var barX=barWidth*i;
                            drawctx.fillStyle="green";
                            drawctx.fillRect(barX,0,barWidth,barHeight);
                        };
                    };
                    window.requestAnimationFrame(renderFrame);
                };
                analyser_handler();
            });
        </script>
    </body>
</html>