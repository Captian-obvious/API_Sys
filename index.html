<!DOCTYPE html>
<html>
    <head>
        <title>Asset "{{ ASSET_NAME }}"</title>
        <link rel="stylesheet" href="styles.css"/>
        <link rel="icon" href="images/favicon.png"/>
        <link rel="icon" href="favicon.ico"/>
    </head>
    <body>
        <canvas id="visualizer"></canvas>
        <h1 class="asset_title">{{ ASSET_NAME_ID }}</h1>
        <h1 class="asset_moderated_message" hidden>Asset is private, archived, or has been moderated</h1>
        <div id="mediaPlayerControls">
            <audio id="playable" src="{{ CACHE_SOURCE }}" hidden></audio>
            <div id="picture"></div>
            <div id="icon_playpause" class="media_icon icon_play"></div>
            <input id="slider_time" type="range" value="0"/>
        </div>
        <script id="mediaPlayerHandler">
            window.addEventListener("load",function(ev){
                var image=document.getElementById("picture");
                var media_icon=document.getElementById("icon_playpause");
                var durationSlider=document.getElementById("slider_time");
                var theaudio=document.getElementById("playable");
                var canvas=document.getElementById("visualizer");
                var isPlay=false;
                theaudio.load();
                image.style.backgroundImage="url(https://www.roblox.com/asset-thumbnail/image?assetId={{ ASSET_ID }}&width=420&height=420&format=png)";
                theaudio.addEventListener("timeupdate", function() {
                    durationSlider.value=theaudio.currentTime;
                    durationSlider.max=theaudio.duration;
                });
                durationSlider.addEventListener("change", function() {
                    theaudio.currentTime=durationSlider.value;
                });
                theaudio.addEventListener("ended",function(ev){
                    durationSlider.value=durationSlider.max;
                });
                theaudio.addEventListener("pause",function(ev){
                    isPlay=false;
                    media_icon.className="media_icon icon_play";
                });
                theaudio.addEventListener("play",function(ev){
                    isPlay=true;
                    media_icon.className="media_icon icon_pause";
                });
                var audioctx,mediaSource,analyser,freqBinCount,dataArray;
                function analyser_handler(){
                    canvas.width=window.innerWidth;
                    canvas.height=window.innerHeight;
                    var drawctx=canvas.getContext("2d");
                    function renderFrame(){
                        analyser.getByteFrequencyData(dataArray);
                        canvas.width=window.innerWidth;
                        canvas.height=window.innerHeight;
                        var canvasWidth=canvas.width;
                        var canvasHeight=canvas.height;
                        var barWidth=(canvasWidth/freqBinCount);
                        drawctx.clearRect(0,0,canvasWidth,canvasHeight);
                        for (var i=0;i<freqBinCount;i++) {
                            var barHeight=dataArray[i]/255 * (.6 * canvasHeight) ;
                            var barX=barWidth*i;
                            drawctx.fillStyle=`rgb(${barHeight + 100} 50 50)`;
                            renderWidth=barWidth-2;
                            if (renderWidth<1) renderWidth=1;
                            drawctx.fillRect(barX,0,renderWidth,barHeight);
                        };
                        window.requestAnimationFrame(renderFrame);
                    };
                    renderFrame();
                };
                media_icon.addEventListener("click",function(ev){
                    if (!audioctx){
                        audioctx=new AudioContext();
                        mediaSource=audioctx.createMediaElementSource(theaudio);
                        analyser=new AnalyserNode(audioctx);
                        analyser.fftSize=256;
                        analyser.maxDecibels = -4;
                        mediaSource.connect(analyser);
                        analyser.connect(audioctx.destination);
                        freqBinCount=analyser.frequencyBinCount;
                        dataArray=new Uint8Array(freqBinCount);
                        analyser_handler();
                    };
                    if (isPlay) {
                        isPlay=false;
                        media_icon.className="media_icon icon_play";
                        theaudio.pause();
                    }else{
                        isPlay=true;
                        media_icon.className="media_icon icon_pause";
                        theaudio.play();
                    };
                });
            });
        </script>
    </body>
</html>